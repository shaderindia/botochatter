<!DOCTYPE html>
<html>
<head>
  <title>Mini Facebook - Auth & Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .hidden { display: none; }
    img { max-width: 100px; border-radius: 50%; }
  </style>
</head>
<body>

<h2>Mini Facebook - Profile Setup</h2>

<div id="auth">
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div id="profile" class="hidden">
  <p>Welcome, <span id="user-email"></span></p>
  <img id="avatar" src="" alt="Profile Picture"><br>
  <input id="username" placeholder="Username"><br>
  <input id="avatar-upload" type="file"><br>
  <button onclick="uploadAvatar()">Upload Avatar</button>
  <button onclick="saveProfile()">Save Profile</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  const supabaseUrl = 'https://ytkovceuexbdykxjhbyb.supabase.co';
  const supabaseKey = 'your-anon-key'; // Replace with your actual anon key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  async function signUp() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) alert(error.message);
  }

  async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert(error.message);
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  async function uploadAvatar() {
    const file = document.getElementById('avatar-upload').files[0];
    if (!file) return alert('Select a file first');
    const user = (await supabase.auth.getUser()).data.user;
    const filePath = `${user.id}/${file.name}`;

    const { error: uploadError } = await supabase.storage
      .from('avatars')
      .upload(filePath, file, { upsert: true });

    if (uploadError) return alert('Upload error: ' + uploadError.message);

    const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
    document.getElementById('avatar').src = data.publicUrl;

    // Save to profile
    await supabase.from('profiles').upsert({
      id: user.id,
      avatar_url: data.publicUrl
    });
  }

  async function saveProfile() {
    const username = document.getElementById('username').value;
    const user = (await supabase.auth.getUser()).data.user;
    await supabase.from('profiles').upsert({
      id: user.id,
      username
    });
    alert('Profile saved!');
  }

  async function loadProfile() {
    const user = (await supabase.auth.getUser()).data.user;
    if (!user) return;

    document.getElementById('auth').classList.add('hidden');
    document.getElementById('profile').classList.remove('hidden');
    document.getElementById('user-email').textContent = user.email;

    const { data } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if (data) {
      document.getElementById('username').value = data.username || '';
      if (data.avatar_url) {
        document.getElementById('avatar').src = data.avatar_url;
      }
    }
  }

  // Handle auth state
  supabase.auth.onAuthStateChange((_event, session) => {
    if (session) loadProfile();
  });

  // Auto-load if logged in
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) loadProfile();
  });
</script>

</body>
</html>
